<script>
// 🔗 رابط Google Apps Script (تأكد أنه أحدث رابط ينتهي بـ /exec)
const scriptURL = "https://script.google.com/macros/s/AKfycby9r2Lz_qLHjeZP0njaNgOyu0NdZjVblVYcEZk_d6htkwlc3nbA7plPZrmWy9IhjNHH/exec";

// مراجع العناصر
const form = document.getElementById("characterForm");
const worksContainer = document.getElementById("worksContainer");
const successMsg = document.getElementById("successMessage");
const errorMsg = document.getElementById("errorMessage");
const refreshBtn = document.getElementById("refreshBtn");

// حقول النموذج
const studentClassEl = document.getElementById("studentClass");
const studentNameEl = document.getElementById("studentName");
const characterNameEl = document.getElementById("characterName");
const physicalTraitsEl = document.getElementById("physicalTraits");
const psychologicalTraitsEl = document.getElementById("psychologicalTraits");
const textEvidenceEl = document.getElementById("textEvidence");

// تحميل الأعمال مع منع الكاش
async function loadWorks() {
  worksContainer.innerHTML = "⏳ جارٍ تحميل الأعمال...";
  try {
    const res = await fetch(scriptURL, { cache: "no-store" });
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      worksContainer.innerHTML = '<div class="empty-state">لم يتم إرسال أي أعمال بعد.</div>';
      return;
    }

    worksContainer.innerHTML = data
      .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      .map(w => `
        <div class="student-work">
          <div class="student-name">👤 ${w.student_name} - ${w.student_class}</div>
          <div><strong>الشخصية:</strong> ${w.character_name}</div>
          <div><strong>الصفات الجسدية:</strong> ${w.physical_traits}</div>
          <div><strong>الصفات النفسية:</strong> ${w.psychological_traits}</div>
          ${w.text_evidence ? `<div><strong>الدليل:</strong> ${w.text_evidence}</div>` : ""}
          <div style="font-size:0.8rem;color:#718096;">📅 ${new Date(w.created_at).toLocaleDateString("ar-SA")}</div>
        </div>
      `).join("");
  } catch (err) {
    console.error("Load error:", err);
    worksContainer.innerHTML = '<div class="empty-state">⚠️ لم يمكن تحميل البيانات.</div>';
  }
}

// إرسال مع مسارين: JSON أولاً، وإن فشل جرّب text/plain لتفادي Preflight أحيانًا
async function submitWork(payload) {
  // المحاولة 1: JSON تقليدية
  try {
    const r1 = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    if (r1.ok) return true;
  } catch (e) {
    // ننتقل للمحاولة 2
  }

  // المحاولة 2: text/plain (تساعد في بعض بيئات CORS)
  try {
    const r2 = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    if (r2.ok) return true;
  } catch (e) {
    console.error("Submit error:", e);
  }

  return false;
}

// حدث الإرسال
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  successMsg.style.display = "none";
  errorMsg.style.display = "none";

  const btn = form.querySelector("button[type='submit']");
  btn.disabled = true;
  btn.textContent = "جاري الإرسال...";

  const payload = {
    student_name: studentNameEl.value.trim(),
    student_class: studentClassEl.value.trim(),
    character_name: characterNameEl.value.trim(),
    physical_traits: physicalTraitsEl.value.trim(),
    psychological_traits: psychologicalTraitsEl.value.trim(),
    text_evidence: textEvidenceEl.value.trim()
  };

  // تحقق سريع من الحقول
  if (!payload.student_name || !payload.student_class || !payload.character_name || !payload.physical_traits || !payload.psychological_traits) {
    errorMsg.textContent = "يرجى ملء جميع الحقول المطلوبة.";
    errorMsg.style.display = "block";
    btn.disabled = false;
    btn.textContent = "إرسال الوصف";
    return;
  }

  const ok = await submitWork(payload);

  if (ok) {
    successMsg.style.display = "block";
    form.reset();
    await loadWorks();
    setTimeout(() => successMsg.style.display = "none", 4000);
  } else {
    errorMsg.textContent = "⚠️ لم يتم الإرسال. تحقّق من نشر السكربت كـ Web App (أي شخص حتى المجهول) وأن اسم الورقة s1.";
    errorMsg.style.display = "block";
  }

  btn.disabled = false;
  btn.textContent = "إرسال الوصف";
});

// زر تحديث الأعمال
refreshBtn.addEventListener("click", (e) => {
  e.preventDefault();
  loadWorks();
});

// تحميل أولي
document.addEventListener("DOMContentLoaded", loadWorks);
</script>

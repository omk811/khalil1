<script>
// ğŸ”— Ø±Ø§Ø¨Ø· Google Apps Script (ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ø£Ø­Ø¯Ø« Ø±Ø§Ø¨Ø· ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ /exec)
const scriptURL = "https://script.google.com/macros/s/AKfycby9r2Lz_qLHjeZP0njaNgOyu0NdZjVblVYcEZk_d6htkwlc3nbA7plPZrmWy9IhjNHH/exec";

// Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
const form = document.getElementById("characterForm");
const worksContainer = document.getElementById("worksContainer");
const successMsg = document.getElementById("successMessage");
const errorMsg = document.getElementById("errorMessage");
const refreshBtn = document.getElementById("refreshBtn");

// Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
const studentClassEl = document.getElementById("studentClass");
const studentNameEl = document.getElementById("studentName");
const characterNameEl = document.getElementById("characterName");
const physicalTraitsEl = document.getElementById("physicalTraits");
const psychologicalTraitsEl = document.getElementById("psychologicalTraits");
const textEvidenceEl = document.getElementById("textEvidence");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ÙƒØ§Ø´
async function loadWorks() {
  worksContainer.innerHTML = "â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„...";
  try {
    const res = await fetch(scriptURL, { cache: "no-store" });
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      worksContainer.innerHTML = '<div class="empty-state">Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø¹Ø¯.</div>';
      return;
    }

    worksContainer.innerHTML = data
      .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      .map(w => `
        <div class="student-work">
          <div class="student-name">ğŸ‘¤ ${w.student_name} - ${w.student_class}</div>
          <div><strong>Ø§Ù„Ø´Ø®ØµÙŠØ©:</strong> ${w.character_name}</div>
          <div><strong>Ø§Ù„ØµÙØ§Øª Ø§Ù„Ø¬Ø³Ø¯ÙŠØ©:</strong> ${w.physical_traits}</div>
          <div><strong>Ø§Ù„ØµÙØ§Øª Ø§Ù„Ù†ÙØ³ÙŠØ©:</strong> ${w.psychological_traits}</div>
          ${w.text_evidence ? `<div><strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> ${w.text_evidence}</div>` : ""}
          <div style="font-size:0.8rem;color:#718096;">ğŸ“… ${new Date(w.created_at).toLocaleDateString("ar-SA")}</div>
        </div>
      `).join("");
  } catch (err) {
    console.error("Load error:", err);
    worksContainer.innerHTML = '<div class="empty-state">âš ï¸ Ù„Ù… ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>';
  }
}

// Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ Ù…Ø³Ø§Ø±ÙŠÙ†: JSON Ø£ÙˆÙ„Ø§Ù‹ØŒ ÙˆØ¥Ù† ÙØ´Ù„ Ø¬Ø±Ù‘Ø¨ text/plain Ù„ØªÙØ§Ø¯ÙŠ Preflight Ø£Ø­ÙŠØ§Ù†Ù‹Ø§
async function submitWork(payload) {
  // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1: JSON ØªÙ‚Ù„ÙŠØ¯ÙŠØ©
  try {
    const r1 = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    if (r1.ok) return true;
  } catch (e) {
    // Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2
  }

  // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2: text/plain (ØªØ³Ø§Ø¹Ø¯ ÙÙŠ Ø¨Ø¹Ø¶ Ø¨ÙŠØ¦Ø§Øª CORS)
  try {
    const r2 = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    if (r2.ok) return true;
  } catch (e) {
    console.error("Submit error:", e);
  }

  return false;
}

// Ø­Ø¯Ø« Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  successMsg.style.display = "none";
  errorMsg.style.display = "none";

  const btn = form.querySelector("button[type='submit']");
  btn.disabled = true;
  btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

  const payload = {
    student_name: studentNameEl.value.trim(),
    student_class: studentClassEl.value.trim(),
    character_name: characterNameEl.value.trim(),
    physical_traits: physicalTraitsEl.value.trim(),
    psychological_traits: psychologicalTraitsEl.value.trim(),
    text_evidence: textEvidenceEl.value.trim()
  };

  // ØªØ­Ù‚Ù‚ Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„
  if (!payload.student_name || !payload.student_class || !payload.character_name || !payload.physical_traits || !payload.psychological_traits) {
    errorMsg.textContent = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.";
    errorMsg.style.display = "block";
    btn.disabled = false;
    btn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙ";
    return;
  }

  const ok = await submitWork(payload);

  if (ok) {
    successMsg.style.display = "block";
    form.reset();
    await loadWorks();
    setTimeout(() => successMsg.style.display = "none", 4000);
  } else {
    errorMsg.textContent = "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙƒÙ€ Web App (Ø£ÙŠ Ø´Ø®Øµ Ø­ØªÙ‰ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„) ÙˆØ£Ù† Ø§Ø³Ù… Ø§Ù„ÙˆØ±Ù‚Ø© s1.";
    errorMsg.style.display = "block";
  }

  btn.disabled = false;
  btn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙ";
});

// Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
refreshBtn.addEventListener("click", (e) => {
  e.preventDefault();
  loadWorks();
});

// ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
document.addEventListener("DOMContentLoaded", loadWorks);
</script>
